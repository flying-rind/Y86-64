# 使用向量部件加速循环

面向以下循环，设计一个向量加速部件，测试加速前和加速后的加速比
```
for(i=0;i<1024;i++)
    y[i] += a * x[i]
```
## 测试方法

* 不加速：我们采用自己设计的Y86指令集的五级流水线CPU进行测试，逐个周期进行模拟。注意在我们的CPU中，数据冲突和控制冲突都只采用了阻塞的方式来避免。

* 加速，通过设计向量寄存器组，向量乘部件、向量加部件、和向量存取部件，对这个循环进行加速，也通过逐个周期模拟计算总的周期数。

## 1. 采用传统五级流水线CPU
我们将上述循环转化为下面一段汇编代码，并加载到CPU中去执行
```
irmovq 1,    %r8,
irmovq 1024, %r9,
irmovq a,    %r11,

L1:
    mrmovq 1024(%rcx), %rax
    mrmovq 0(%rcx),    %rbx
    multq  %r11,       %rbx
    addq   %rbx,       %rax
    rmmovq %rax, 1024(%rdx)
    addq   %r8,        %rcx
    rrmovq %rcx,       %rdx
    subq   %r9,        %rdx
    jne L1
```
最终执行总周期数为30724周期

## 2. 采用向量加速部件
在我们的设计中，有一个64*64的向量寄存器组，为了完成1024个元素的运算，我们需要分组，共重复执行以下向量指令1024/64 = 16次
使用的向量指令如下：
```
LV V1 <- x                                          编组1
------------------------------------------------    
MULTSV V2 <- a*V1
LV V3 <- y                                          编组2
------------------------------------------------
ADDV V4 <- V3 + V2                                  编组3
------------------------------------------------
SV Ry <- V4                                         编组4
```
由于每个向量运算部件只有一个，所以同一时刻只能有一个LV部件运行

<span style="color:red">首先执行编组1，然后编组2并行、编组2、3链接，3、4链接</span>

最终执行时间为2448周期

## 3. 加速比
计算得加速比为12.55